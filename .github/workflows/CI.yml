name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:

  # This runs all the time except when we're pushing to main; we've
  # already run tests in the PR and after we increment the semantic
  # release number, we're going to run tests on that commit anyway so
  # there's no point to run tests a third time.
  Build:
    if: "!(github.ref == 'refs/heads/main' && github.event_name == 'push')"
    uses: msalib/py-geo-rasterize/.github/workflows/build.yml@main
    with:
      ref: ${GITHUB_REF_NAME}

  # This only runs when we push to main. Instead of running tests, we
  # bump the version and make a tag.
  BumpVersion:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Python Semantic Release
        uses: relekang/python-semantic-release@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - run: git push

  # We've got a new version! `Build` will run and after it finishes we
  # can publish!
  Publish:
    runs-on: ubuntu-latest
    if: "startsWith(github.ref, 'refs/tags/')"
    needs: [ Build ]
    steps:
      - uses: actions/download-artifact@v2
        with:
          name: wheels
      - name: Publish to PyPI
        uses: messense/maturin-action@v1
        env:
          MATURIN_PYPI_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        with:
          command: upload
          args: --repository-url=https://test.pypi.org/legacy/ --username=msalib --skip-existing *
